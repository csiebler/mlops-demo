variables: 
 - template: german-credit-config.yml

trigger: none

pool:
  vmImage: ubuntu-20.04

steps:
  - task: AzureCLI@2
    displayName: 'Configure AML CLI v2'
    inputs:
      azureSubscription: $(ml_workspace_connection)
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az extension add -n ml -y
        az configure --defaults group=$(ml_workspace_rg) workspace=$(ml_workspace_name) location=$(ml_workspace_region)

  - task: AzureCLI@2
    displayName: 'Train, explain and register model'
    inputs:
      azureSubscription: $(ml_workspace_connection)
      scriptType: bash
      scriptLocation: inlineScript
      workingDirectory: $(ml_model_path)
      inlineScript: |
        job_name=`az ml job create --file azureml/train.yml | jq .name -r`
        echo "Started job with job_name: $job_name"
        az ml job stream --name $job_name
        az ml model create --name $(ml_model_name) --path runs:/$job_name/outputs